<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>SFacts - Enhanced Analytic Hierarchy Process (AHP) Tool</title>
    <meta name="description" content="Advanced AHP tool with sensitivity analysis, form validation, and enhanced features for decision making">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/chartist.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <script>
        var global = window;
        // Remove query params to prevent interference with auto-save/auto-load feature
        if (window.location.search) {
            window.location = window.location.pathname;
        }
        
        // Prevent form submission that clears data
        window.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('ahpdata');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
        });
    </script>
    
    <!-- Core AHP System -->
    <script defer src="js/index.js"></script>
    
    <!-- Enhanced SFacts System (ES6 Modules) -->
    <script type="module">
        import('./js/modules/main.js').then(() => {
            console.log('üöÄ SFacts Enhanced 2.0 loaded successfully');
        }).catch(error => {
            console.warn('Enhanced modules not available:', error);
        });
    </script>
    
    <!-- Original System (for compatibility) -->
    <script defer src="js/rolledup.js"></script>
    
    <!-- Enhanced Integration Layer -->
    <script defer src="js/enhanced-integration.js"></script>
    
    <style>
        /* Enhanced System Styles */
        .enhanced-features {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .system-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .system-status.active {
            color: #28a745;
        }
        
        .system-status.loading {
            color: #ffc107;
        }
        
        .system-status.error {
            color: #dc3545;
        }
        
        /* Fix for Calculate button */
        #calcbtn {
            cursor: pointer;
        }
        
        /* Data protection warning */
        .data-protection {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #856404;
        }
        
        .data-protection strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <header class="wrapper">
            <h1>
                SFacts - Analytic Hierarchy Process (AHP) Tool
                <span class="enhanced-features">Enhanced v2.0</span>
            </h1>
            <div class="system-status" id="system-status">
                Loading enhanced features...
            </div>
        </header>
    </div>

    <div class="main wrapper">
        <aside>
            <h3>About AHP</h3>
            <p>The Analytic Hierarchy Process (AHP) is a structured technique for organizing and analyzing complex decisions.</p>
            <p><a href="https://en.wikipedia.org/wiki/Analytic_hierarchy_process" target="_blank">Learn more on Wikipedia</a></p>
            
            <h3>Data Management</h3>
            <p>
                <button id="datamgmt_reset">Reset</button>
                <button id="datamgmt_export">Export</button>
                <button id="datamgmt_import">Import</button>
            </p>
            <textarea id="datamgmt" placeholder="Data import/export area..."></textarea>
            
            <!-- Data Protection Warning -->
            <div class="data-protection" id="data-protection-warning" style="display: none;">
                <strong>‚ö†Ô∏è Data Protection Active</strong>
                Your input data is protected and won't be cleared during calculations.
            </div>
            
            <!-- Enhanced Control Panel will be inserted here by enhanced-integration.js -->
        </aside>

        <form id="ahpdata" name="ahpdata" onsubmit="return false;">
            <!-- Goal Section -->
            <section>
                <h1>Decision Goal</h1>
                <textarea id="goal" placeholder="Describe your decision goal..."></textarea>
            </section>

            <!-- Criteria Section -->
            <section id="criteria_inputs">
                <h1>Evaluation Criteria</h1>
                <p>Enter your criteria below (up to 8):</p>
                <div class="input-grid">
                    <input type="text" id="criteria0" name="criteria0" placeholder="Criterion 1" />
                    <input type="text" id="criteria1" name="criteria1" placeholder="Criterion 2" />
                    <input type="text" id="criteria2" name="criteria2" placeholder="Criterion 3" />
                    <input type="text" id="criteria3" name="criteria3" placeholder="Criterion 4" />
                    <input type="text" id="criteria4" name="criteria4" placeholder="Criterion 5" />
                    <input type="text" id="criteria5" name="criteria5" placeholder="Criterion 6" />
                    <input type="text" id="criteria6" name="criteria6" placeholder="Criterion 7" />
                    <input type="text" id="criteria7" name="criteria7" placeholder="Criterion 8" />
                </div>
            </section>

            <!-- Alternatives Section -->
            <section id="items_inputs">
                <h1>Decision Alternatives</h1>
                <p>Enter your alternatives below (up to 8):</p>
                <div class="input-grid">
                    <input type="text" id="item0" name="item0" placeholder="Alternative 1" />
                    <input type="text" id="item1" name="item1" placeholder="Alternative 2" />
                    <input type="text" id="item2" name="item2" placeholder="Alternative 3" />
                    <input type="text" id="item3" name="item3" placeholder="Alternative 4" />
                    <input type="text" id="item4" name="item4" placeholder="Alternative 5" />
                    <input type="text" id="item5" name="item5" placeholder="Alternative 6" />
                    <input type="text" id="item6" name="item6" placeholder="Alternative 7" />
                    <input type="text" id="item7" name="item7" placeholder="Alternative 8" />
                </div>
            </section>

            <!-- Criteria Pairwise Comparisons -->
            <section id="pairwise_criteria" class="pairwise_criteria pairwisetable">
                <h1>Criteria Pairwise Comparisons</h1>
                <p>Compare each criterion against others with respect to your goal.</p>
                <aside id="pairwise_criteria_sentence"></aside>
                <table>
                    <!-- Table content remains the same -->
                </table>
            </section>

            <!-- Alternatives Pairwise Comparisons -->
            <section id="pairwise_items" class="pairwise_items pairwisetable">
                <h1>Alternatives Pairwise Comparisons</h1>
                <p>Compare each alternative against others with respect to each criterion.</p>
                
                <!-- Criterion 0 Comparisons -->
                <section id="c0_items" class="c0_items">
                    <h2 class="criteria0"></h2>
                    <aside id="criteria0_sentence"></aside>
                    <table>
                        <!-- Table content remains the same -->
                    </table>
                </section>
                
                <!-- Additional criteria sections remain -->
            </section>

            <!-- Calculation Buttons -->
            <section class="calculation-buttons">
                <button type="button" id="calcbtn" class="btn-primary">Calculate Results</button>
                <!-- Enhanced Calculate button will be added here automatically -->
            </section>
        </form>

        <!-- Results Section -->
        <section id="results" class="results">
            <h1>Analysis Results</h1>
            
            <!-- Basic Results -->
            <div class="basic-results">
                <h2>Criteria Weights</h2>
                <div class="ct-chart ct-octave" id="criteria"></div>
                
                <h2>Alternative Scores</h2>
                <div class="ct-chart ct-double-octave" id="rankings"></div>
            </div>
            
            <!-- Enhanced Results Section will be inserted here by enhanced-integration.js -->
        </section>
    </div>

    <div class="footer-container">
        <footer class="wrapper">
            <h3>Open Source Project</h3>
            <p>
                This tool is based on the original <a href="https://github.com/ComcastSamples/ahp-tool">AHP Tool by Comcast</a>.
                Enhanced with SFacts 2.0 featuring sensitivity analysis, form validation, and advanced export options.
            </p>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                SFacts Enhanced v2.0 | Data protection enabled | Built with modern JavaScript (ES6 Modules)
            </p>
        </footer>
    </div>

    <script>
        // Update system status when enhanced features load
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('system-status');
            const warningElement = document.getElementById('data-protection-warning');
            
            // Show data protection warning
            if (warningElement) {
                warningElement.style.display = 'block';
            }
            
            // Fix the Calculate button to prevent form submission
            const calcBtn = document.getElementById('calcbtn');
            if (calcBtn) {
                // Remove any existing onclick that might clear data
                calcBtn.onclick = null;
                
                // Store original click handler
                const originalClick = calcBtn.onclick;
                
                // Replace with our protected handler
                calcBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    console.log('Protected Calculate button clicked');
                    
                    // First, save current form data
                    saveFormData();
                    
                    // Then run the original calculation
                    if (originalClick) {
                        originalClick.call(this, e);
                    } else {
                        // If no original handler, use default
                        runSafeCalculation();
                    }
                    
                    return false;
                });
                
                // Also change button type to prevent form submission
                calcBtn.type = 'button';
            }
            
            // Prevent form submission completely
            const form = document.getElementById('ahpdata');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
                
                // Also prevent default on all submit buttons
                form.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.type = 'button';
                });
            }
            
            // Check for enhanced system periodically
            const checkEnhancedSystem = setInterval(() => {
                if (window.SFactsApp) {
                    statusElement.textContent = 'Enhanced features: Ready ‚úì';
                    statusElement.className = 'system-status active';
                    clearInterval(checkEnhancedSystem);
                }
            }, 1000);
            
            // Fallback if enhanced system doesn't load
            setTimeout(() => {
                if (!window.SFactsApp) {
                    statusElement.textContent = 'Enhanced features: Not available (using basic mode)';
                    statusElement.className = 'system-status';
                }
            }, 5000);
            
            // Add CSS for input grid
            const style = document.createElement('style');
            style.textContent = `
                .input-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                    margin-bottom: 15px;
                }
                
                .input-grid input {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                }
                
                .calculation-buttons {
                    margin: 20px 0;
                    padding: 20px 0;
                    border-top: 1px solid #eee;
                }
                
                .btn-primary {
                    background: #007cba;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 4px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: background 0.3s ease;
                }
                
                .btn-primary:hover {
                    background: #005a87;
                }
                
                @media (max-width: 768px) {
                    .input-grid {
                        grid-template-columns: 1fr;
                    }
                }
            `;
            document.head.appendChild(style);
        });
        
        // Function to save form data before calculation
        function saveFormData() {
            try {
                const formData = {
                    goal: document.getElementById('goal')?.value || '',
                    items: [],
                    criteria: [],
                    timestamp: new Date().toISOString()
                };
                
                // Save items
                for (let i = 0; i < 8; i++) {
                    const item = document.getElementById('item' + i);
                    if (item) formData.items.push(item.value || '');
                }
                
                // Save criteria
                for (let i = 0; i < 8; i++) {
                    const criterion = document.getElementById('criteria' + i);
                    if (criterion) formData.criteria.push(criterion.value || '');
                }
                
                // Save to session storage as backup
                sessionStorage.setItem('ahp_form_backup', JSON.stringify(formData));
                console.log('Form data saved as backup');
                
            } catch (error) {
                console.warn('Could not save form data:', error);
            }
        }
        
        // Function to restore form data if needed
        function restoreFormData() {
            try {
                const saved = sessionStorage.getItem('ahp_form_backup');
                if (saved) {
                    const formData = JSON.parse(saved);
                    
                    // Restore goal
                    const goalInput = document.getElementById('goal');
                    if (goalInput && formData.goal) {
                        goalInput.value = formData.goal;
                    }
                    
                    // Restore items
                    formData.items.forEach((value, index) => {
                        const input = document.getElementById('item' + index);
                        if (input && value) {
                            input.value = value;
                        }
                    });
                    
                    // Restore criteria
                    formData.criteria.forEach((value, index) => {
                        const input = document.getElementById('criteria' + index);
                        if (input && value) {
                            input.value = value;
                        }
                    });
                    
                    console.log('Form data restored from backup');
                }
            } catch (error) {
                console.warn('Could not restore form data:', error);
            }
        }
        
        // Safe calculation function
        function runSafeCalculation() {
            console.log('Running safe calculation...');
            
            // First save current data
            saveFormData();
            
            // Show loading indicator
            const calcBtn = document.getElementById('calcbtn');
            if (calcBtn) {
                const originalText = calcBtn.textContent;
                calcBtn.textContent = 'Calculating...';
                calcBtn.disabled = true;
                
                // Restore button after calculation
                setTimeout(() => {
                    calcBtn.textContent = originalText;
                    calcBtn.disabled = false;
                }, 1000);
            }
            
            // Try to trigger the original calculation
            try {
                // Check if runCalculation function exists
                if (typeof window.runCalculation === 'function') {
                    // Collect data manually
                    const items = [];
                    const criteria = [];
                    
                    for (let i = 0; i < 8; i++) {
                        const item = document.getElementById('item' + i)?.value;
                        const criterion = document.getElementById('criteria' + i)?.value;
                        
                        if (item) items.push(item);
                        if (criterion) criteria.push(criterion);
                    }
                    
                    if (items.length >= 2 && criteria.length >= 2) {
                        // Run calculation
                        window.runCalculation(items, criteria, [], []);
                    } else {
                        alert('Please enter at least 2 items and 2 criteria');
                    }
                }
            } catch (error) {
                console.error('Calculation error:', error);
                alert('Calculation failed. Please check your inputs.');
                
                // Restore data if calculation failed
                restoreFormData();
            }
        }
        
        // Auto-save form data periodically
        setInterval(saveFormData, 30000); // Save every 30 seconds
        
        // Restore data on page load
        window.addEventListener('load', function() {
            setTimeout(restoreFormData, 500);
        });
    </script>
</body>
</html>
